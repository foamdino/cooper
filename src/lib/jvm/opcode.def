/*
 * SPDX-FileCopyrightText: (c) 2025 Kev Jackson <foamdino@gmail.com>
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

#ifdef OPCODE
/* From https://docs.oracle.com/javase/specs/jvms/se25/html/jvms-7.html */
/* OPCODE(val, name, len, is_branch, pop_count, push_count, pop_types, push_types, flags) */
/*
 * Type codes:
 *   I = Integer (int, boolean, byte, char, short)
 *   J = Long (2 slots)
 *   F = Float
 *   D = Double (2 slots)
 *   R = Reference (object/array)
 *   ? = Variable (requires constant pool lookup or runtime resolution)
 *   = = Copy top of stack (dup operations)
 *
 * Flags (bitmask):
 *   0x01 NEEDS_CP    - Requires constant pool lookup for type resolution
 *   0x02 VARIABLE    - Complex/variable behavior, needs manual handler
 *   0x04 USES_LOCALS - Reads or writes local variables
 *   0x08 STACK_DUP   - Stack duplication/manipulation operation
 *   0x10 IS_RETURN   - Method return instruction
 *   0x20 IS_THROW    - Throws exception (athrow)
 */

/* == Constants ============================================================ */
OPCODE(0x00, nop,         1, 0,  0, 0, "",   "",  0)
OPCODE(0x01, aconst_null, 1, 0,  0, 1, "",   "R", 0)
OPCODE(0x02, iconst_m1,   1, 0,  0, 1, "",   "I", 0)
OPCODE(0x03, iconst_0,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x04, iconst_1,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x05, iconst_2,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x06, iconst_3,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x07, iconst_4,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x08, iconst_5,    1, 0,  0, 1, "",   "I", 0)
OPCODE(0x09, lconst_0,    1, 0,  0, 1, "",   "J", 0)
OPCODE(0x0a, lconst_1,    1, 0,  0, 1, "",   "J", 0)
OPCODE(0x0b, fconst_0,    1, 0,  0, 1, "",   "F", 0)
OPCODE(0x0c, fconst_1,    1, 0,  0, 1, "",   "F", 0)
OPCODE(0x0d, fconst_2,    1, 0,  0, 1, "",   "F", 0)
OPCODE(0x0e, dconst_0,    1, 0,  0, 1, "",   "D", 0)
OPCODE(0x0f, dconst_1,    1, 0,  0, 1, "",   "D", 0)
OPCODE(0x10, bipush,      2, 0,  0, 1, "",   "I", 0)
OPCODE(0x11, sipush,      3, 0,  0, 1, "",   "I", 0)

/* == LDC (constant pool load) ============================================= */
OPCODE(0x12, ldc,         2, 0,  0, 1, "",   "?", NEEDS_CP|VARIABLE)
OPCODE(0x13, ldc_w,       3, 0,  0, 1, "",   "?", NEEDS_CP|VARIABLE)
OPCODE(0x14, ldc2_w,      3, 0,  0, 1, "",   "?", NEEDS_CP|VARIABLE)

/* == Loads (local -> stack) =============================================== */
OPCODE(0x15, iload,       2, 0,  0, 1, "",   "I", USES_LOCALS)
OPCODE(0x16, lload,       2, 0,  0, 1, "",   "J", USES_LOCALS)
OPCODE(0x17, fload,       2, 0,  0, 1, "",   "F", USES_LOCALS)
OPCODE(0x18, dload,       2, 0,  0, 1, "",   "D", USES_LOCALS)
OPCODE(0x19, aload,       2, 0,  0, 1, "",   "R", USES_LOCALS)
OPCODE(0x1a, iload_0,     1, 0,  0, 1, "",   "I", USES_LOCALS)
OPCODE(0x1b, iload_1,     1, 0,  0, 1, "",   "I", USES_LOCALS)
OPCODE(0x1c, iload_2,     1, 0,  0, 1, "",   "I", USES_LOCALS)
OPCODE(0x1d, iload_3,     1, 0,  0, 1, "",   "I", USES_LOCALS)
OPCODE(0x1e, lload_0,     1, 0,  0, 1, "",   "J", USES_LOCALS)
OPCODE(0x1f, lload_1,     1, 0,  0, 1, "",   "J", USES_LOCALS)
OPCODE(0x20, lload_2,     1, 0,  0, 1, "",   "J", USES_LOCALS)
OPCODE(0x21, lload_3,     1, 0,  0, 1, "",   "J", USES_LOCALS)
OPCODE(0x22, fload_0,     1, 0,  0, 1, "",   "F", USES_LOCALS)
OPCODE(0x23, fload_1,     1, 0,  0, 1, "",   "F", USES_LOCALS)
OPCODE(0x24, fload_2,     1, 0,  0, 1, "",   "F", USES_LOCALS)
OPCODE(0x25, fload_3,     1, 0,  0, 1, "",   "F", USES_LOCALS)
OPCODE(0x26, dload_0,     1, 0,  0, 1, "",   "D", USES_LOCALS)
OPCODE(0x27, dload_1,     1, 0,  0, 1, "",   "D", USES_LOCALS)
OPCODE(0x28, dload_2,     1, 0,  0, 1, "",   "D", USES_LOCALS)
OPCODE(0x29, dload_3,     1, 0,  0, 1, "",   "D", USES_LOCALS)
OPCODE(0x2a, aload_0,     1, 0,  0, 1, "",   "R", USES_LOCALS)
OPCODE(0x2b, aload_1,     1, 0,  0, 1, "",   "R", USES_LOCALS)
OPCODE(0x2c, aload_2,     1, 0,  0, 1, "",   "R", USES_LOCALS)
OPCODE(0x2d, aload_3,     1, 0,  0, 1, "",   "R", USES_LOCALS)

/* == Array loads (arrayref, index -> value) =============================== */
OPCODE(0x2e, iaload,      1, 0,  2, 1, "RI", "I", 0)
OPCODE(0x2f, laload,      1, 0,  2, 1, "RI", "J", 0)
OPCODE(0x30, faload,      1, 0,  2, 1, "RI", "F", 0)
OPCODE(0x31, daload,      1, 0,  2, 1, "RI", "D", 0)
OPCODE(0x32, aaload,      1, 0,  2, 1, "RI", "R", 0)
OPCODE(0x33, baload,      1, 0,  2, 1, "RI", "I", 0)
OPCODE(0x34, caload,      1, 0,  2, 1, "RI", "I", 0)
OPCODE(0x35, saload,      1, 0,  2, 1, "RI", "I", 0)

/* == Stores (stack -> local) ============================================== */
OPCODE(0x36, istore,      2, 0,  1, 0, "I",  "",  USES_LOCALS)
OPCODE(0x37, lstore,      2, 0,  1, 0, "J",  "",  USES_LOCALS)
OPCODE(0x38, fstore,      2, 0,  1, 0, "F",  "",  USES_LOCALS)
OPCODE(0x39, dstore,      2, 0,  1, 0, "D",  "",  USES_LOCALS)
OPCODE(0x3a, astore,      2, 0,  1, 0, "R",  "",  USES_LOCALS)
OPCODE(0x3b, istore_0,    1, 0,  1, 0, "I",  "",  USES_LOCALS)
OPCODE(0x3c, istore_1,    1, 0,  1, 0, "I",  "",  USES_LOCALS)
OPCODE(0x3d, istore_2,    1, 0,  1, 0, "I",  "",  USES_LOCALS)
OPCODE(0x3e, istore_3,    1, 0,  1, 0, "I",  "",  USES_LOCALS)
OPCODE(0x3f, lstore_0,    1, 0,  1, 0, "J",  "",  USES_LOCALS)
OPCODE(0x40, lstore_1,    1, 0,  1, 0, "J",  "",  USES_LOCALS)
OPCODE(0x41, lstore_2,    1, 0,  1, 0, "J",  "",  USES_LOCALS)
OPCODE(0x42, lstore_3,    1, 0,  1, 0, "J",  "",  USES_LOCALS)
OPCODE(0x43, fstore_0,    1, 0,  1, 0, "F",  "",  USES_LOCALS)
OPCODE(0x44, fstore_1,    1, 0,  1, 0, "F",  "",  USES_LOCALS)
OPCODE(0x45, fstore_2,    1, 0,  1, 0, "F",  "",  USES_LOCALS)
OPCODE(0x46, fstore_3,    1, 0,  1, 0, "F",  "",  USES_LOCALS)
OPCODE(0x47, dstore_0,    1, 0,  1, 0, "D",  "",  USES_LOCALS)
OPCODE(0x48, dstore_1,    1, 0,  1, 0, "D",  "",  USES_LOCALS)
OPCODE(0x49, dstore_2,    1, 0,  1, 0, "D",  "",  USES_LOCALS)
OPCODE(0x4a, dstore_3,    1, 0,  1, 0, "D",  "",  USES_LOCALS)
OPCODE(0x4b, astore_0,    1, 0,  1, 0, "R",  "",  USES_LOCALS)
OPCODE(0x4c, astore_1,    1, 0,  1, 0, "R",  "",  USES_LOCALS)
OPCODE(0x4d, astore_2,    1, 0,  1, 0, "R",  "",  USES_LOCALS)
OPCODE(0x4e, astore_3,    1, 0,  1, 0, "R",  "",  USES_LOCALS)

/* == Array stores (arrayref, index, value ->) ============================= */
OPCODE(0x4f, iastore,     1, 0,  3, 0, "RII", "", 0)
OPCODE(0x50, lastore,     1, 0,  3, 0, "RIJ", "", 0)
OPCODE(0x51, fastore,     1, 0,  3, 0, "RIF", "", 0)
OPCODE(0x52, dastore,     1, 0,  3, 0, "RID", "", 0)
OPCODE(0x53, aastore,     1, 0,  3, 0, "RIR", "", 0)
OPCODE(0x54, bastore,     1, 0,  3, 0, "RII", "", 0)
OPCODE(0x55, castore,     1, 0,  3, 0, "RII", "", 0)
OPCODE(0x56, sastore,     1, 0,  3, 0, "RII", "", 0)

/* == Stack manipulation =================================================== */
OPCODE(0x57, pop,         1, 0,  1, 0, "?",  "",  VARIABLE)
OPCODE(0x58, pop2,        1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x59, dup,         1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5a, dup_x1,      1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5b, dup_x2,      1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5c, dup2,        1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5d, dup2_x1,     1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5e, dup2_x2,     1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)
OPCODE(0x5f, swap,        1, 0,  0, 0, "",   "",  VARIABLE|STACK_DUP)

/* == Integer arithmetic =================================================== */
OPCODE(0x60, iadd,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x61, ladd,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x62, fadd,        1, 0,  2, 1, "FF", "F", 0)
OPCODE(0x63, dadd,        1, 0,  2, 1, "DD", "D", 0)
OPCODE(0x64, isub,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x65, lsub,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x66, fsub,        1, 0,  2, 1, "FF", "F", 0)
OPCODE(0x67, dsub,        1, 0,  2, 1, "DD", "D", 0)
OPCODE(0x68, imul,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x69, lmul,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x6a, fmul,        1, 0,  2, 1, "FF", "F", 0)
OPCODE(0x6b, dmul,        1, 0,  2, 1, "DD", "D", 0)
OPCODE(0x6c, idiv,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x6d, ldiv,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x6e, fdiv,        1, 0,  2, 1, "FF", "F", 0)
OPCODE(0x6f, ddiv,        1, 0,  2, 1, "DD", "D", 0)
OPCODE(0x70, irem,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x71, lrem,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x72, frem,        1, 0,  2, 1, "FF", "F", 0)
OPCODE(0x73, drem,        1, 0,  2, 1, "DD", "D", 0)
OPCODE(0x74, ineg,        1, 0,  1, 1, "I",  "I", 0)
OPCODE(0x75, lneg,        1, 0,  1, 1, "J",  "J", 0)
OPCODE(0x76, fneg,        1, 0,  1, 1, "F",  "F", 0)
OPCODE(0x77, dneg,        1, 0,  1, 1, "D",  "D", 0)

/* == Shifts =============================================================== */
OPCODE(0x78, ishl,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x79, lshl,        1, 0,  2, 1, "JI", "J", 0)
OPCODE(0x7a, ishr,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x7b, lshr,        1, 0,  2, 1, "JI", "J", 0)
OPCODE(0x7c, iushr,       1, 0,  2, 1, "II", "I", 0)
OPCODE(0x7d, lushr,       1, 0,  2, 1, "JI", "J", 0)

/* == Bitwise ============================================================== */
OPCODE(0x7e, iand,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x7f, land,        1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x80, ior,         1, 0,  2, 1, "II", "I", 0)
OPCODE(0x81, lor,         1, 0,  2, 1, "JJ", "J", 0)
OPCODE(0x82, ixor,        1, 0,  2, 1, "II", "I", 0)
OPCODE(0x83, lxor,        1, 0,  2, 1, "JJ", "J", 0)

/* == iinc (local variable increment - doesn't touch stack) ================ */
OPCODE(0x84, iinc,        3, 0,  0, 0, "",   "",  USES_LOCALS)

/* == Type conversions ===================================================== */
OPCODE(0x85, i2l,         1, 0,  1, 1, "I",  "J", 0)
OPCODE(0x86, i2f,         1, 0,  1, 1, "I",  "F", 0)
OPCODE(0x87, i2d,         1, 0,  1, 1, "I",  "D", 0)
OPCODE(0x88, l2i,         1, 0,  1, 1, "J",  "I", 0)
OPCODE(0x89, l2f,         1, 0,  1, 1, "J",  "F", 0)
OPCODE(0x8a, l2d,         1, 0,  1, 1, "J",  "D", 0)
OPCODE(0x8b, f2i,         1, 0,  1, 1, "F",  "I", 0)
OPCODE(0x8c, f2l,         1, 0,  1, 1, "F",  "J", 0)
OPCODE(0x8d, f2d,         1, 0,  1, 1, "F",  "D", 0)
OPCODE(0x8e, d2i,         1, 0,  1, 1, "D",  "I", 0)
OPCODE(0x8f, d2l,         1, 0,  1, 1, "D",  "J", 0)
OPCODE(0x90, d2f,         1, 0,  1, 1, "D",  "F", 0)
OPCODE(0x91, i2b,         1, 0,  1, 1, "I",  "I", 0)
OPCODE(0x92, i2c,         1, 0,  1, 1, "I",  "I", 0)
OPCODE(0x93, i2s,         1, 0,  1, 1, "I",  "I", 0)

/* == Comparisons (push int result) ======================================== */
OPCODE(0x94, lcmp,        1, 0,  2, 1, "JJ", "I", 0)
OPCODE(0x95, fcmpl,       1, 0,  2, 1, "FF", "I", 0)
OPCODE(0x96, fcmpg,       1, 0,  2, 1, "FF", "I", 0)
OPCODE(0x97, dcmpl,       1, 0,  2, 1, "DD", "I", 0)
OPCODE(0x98, dcmpg,       1, 0,  2, 1, "DD", "I", 0)

/* == Conditional branches (pop and branch) ================================ */
OPCODE(0x99, ifeq,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9a, ifne,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9b, iflt,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9c, ifge,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9d, ifgt,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9e, ifle,        3, 1,  1, 0, "I",  "",  0)
OPCODE(0x9f, if_icmpeq,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa0, if_icmpne,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa1, if_icmplt,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa2, if_icmpge,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa3, if_icmpgt,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa4, if_icmple,   3, 1,  2, 0, "II", "",  0)
OPCODE(0xa5, if_acmpeq,   3, 1,  2, 0, "RR", "",  0)
OPCODE(0xa6, if_acmpne,   3, 1,  2, 0, "RR", "",  0)

/* == Unconditional branches =============================================== */
OPCODE(0xa7, goto,        3, 1,  0, 0, "",   "",  0)
OPCODE(0xa8, jsr,         3, 1,  0, 1, "",   "R", 0)  /* pushes return address */
OPCODE(0xa9, ret,         2, 0,  0, 0, "",   "",  USES_LOCALS)

/* == Switch (variable length, pops int key) =============================== */
OPCODE(0xaa, tableswitch,  0, 0,  1, 0, "I", "",  VARIABLE)  /* variable length */
OPCODE(0xab, lookupswitch, 0, 0,  1, 0, "I", "",  VARIABLE)  /* variable length */

/* == Returns ============================================================== */
OPCODE(0xac, ireturn,     1, 0,  1, 0, "I",  "",  IS_RETURN)
OPCODE(0xad, lreturn,     1, 0,  1, 0, "J",  "",  IS_RETURN)
OPCODE(0xae, freturn,     1, 0,  1, 0, "F",  "",  IS_RETURN)
OPCODE(0xaf, dreturn,     1, 0,  1, 0, "D",  "",  IS_RETURN)
OPCODE(0xb0, areturn,     1, 0,  1, 0, "R",  "",  IS_RETURN)
OPCODE(0xb1, return,      1, 0,  0, 0, "",   "",  IS_RETURN)

/* == Field access (requires CP lookup for field type) ===================== */
OPCODE(0xb2, getstatic,   3, 0,  0, 1, "",   "?", NEEDS_CP|VARIABLE)
OPCODE(0xb3, putstatic,   3, 0,  1, 0, "?",  "",  NEEDS_CP|VARIABLE)
OPCODE(0xb4, getfield,    3, 0,  1, 1, "R",  "?", NEEDS_CP|VARIABLE)
OPCODE(0xb5, putfield,    3, 0,  2, 0, "R?", "",  NEEDS_CP|VARIABLE)

/* == Method invocation (requires descriptor parsing) ====================== */
OPCODE(0xb6, invokevirtual,   3, 0,  0, 0, "?", "?", NEEDS_CP|VARIABLE)
OPCODE(0xb7, invokespecial,   3, 0,  0, 0, "?", "?", NEEDS_CP|VARIABLE)
OPCODE(0xb8, invokestatic,    3, 0,  0, 0, "?", "?", NEEDS_CP|VARIABLE)
OPCODE(0xb9, invokeinterface, 5, 0,  0, 0, "?", "?", NEEDS_CP|VARIABLE)
OPCODE(0xba, invokedynamic,   5, 0,  0, 0, "?", "?", NEEDS_CP|VARIABLE)

/* == Object creation ====================================================== */
OPCODE(0xbb, new,            3, 0,  0, 1, "",  "R", NEEDS_CP)  /* pushes uninitialized ref */
OPCODE(0xbc, newarray,       2, 0,  1, 1, "I", "R", 0)         /* count -> arrayref */
OPCODE(0xbd, anewarray,      3, 0,  1, 1, "I", "R", NEEDS_CP)  /* count -> arrayref */
OPCODE(0xbe, arraylength,    1, 0,  1, 1, "R", "I", 0)         /* arrayref -> length */

/* == Exception ============================================================ */
OPCODE(0xbf, athrow,         1, 0,  1, 0, "R", "",  IS_THROW)

/* == Type checking (requires CP lookup) =================================== */
OPCODE(0xc0, checkcast,      3, 0,  1, 1, "R", "R", NEEDS_CP)  /* ref -> ref (same or cast) */
OPCODE(0xc1, instanceof,     3, 0,  1, 1, "R", "I", NEEDS_CP)  /* ref -> int (0 or 1) */

/* == Monitor ============================================================== */
OPCODE(0xc2, monitorenter,   1, 0,  1, 0, "R", "",  0)
OPCODE(0xc3, monitorexit,    1, 0,  1, 0, "R", "",  0)

/* == Wide & multianewarray ================================================ */
OPCODE(0xc4, wide,           0, 0,  0, 0, "",  "",  VARIABLE)            /* variable length */
OPCODE(0xc5, multianewarray, 4, 0,  0, 1, "?", "R", NEEDS_CP|VARIABLE)  /* pops N counts */

/* == Null branches ======================================================== */
OPCODE(0xc6, ifnull,         3, 1,  1, 0, "R", "",  0)
OPCODE(0xc7, ifnonnull,      3, 1,  1, 0, "R", "",  0)

/* == Wide branches ======================================================== */
OPCODE(0xc8, goto_w,         5, 2,  0, 0, "",  "",  0)
OPCODE(0xc9, jsr_w,          5, 2,  0, 1, "",  "R", 0)  /* pushes return address */

/* == Reserved ============================================================= */
OPCODE(0xca, breakpoint,     0, 0,  0, 0, "",  "",  0)  /* reserved */
OPCODE(0xfe, impdep1,        0, 0,  0, 0, "",  "",  0)  /* reserved */
OPCODE(0xff, impdep2,        0, 0,  0, 0, "",  "",  0)  /* reserved */
#endif
