name: Cooper Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: release

jobs:
  validate-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive changelog
        
    - name: Compile nob build system
      run: cc nob.c -o nob
      
    - name: Build cooper project
      run: ./nob
      
    - name: Run tests before release
      run: ./build/test_cooper

    - name: Install tokei
      run: |
        echo "Installing tokei..."
        TOKEI_VERSION="12.1.2"
        curl -sL https://github.com/XAMPPRocky/tokei/releases/download/v${TOKEI_VERSION}/tokei-x86_64-unknown-linux-gnu.tar.gz | tar xz
        sudo mv tokei /usr/local/bin/
        echo "‚úì Tokei installed: $(tokei --version)"
      
    - name: Generate code statistics
      run: |
        echo "Generating code statistics..."
        
        # Create tokei report
        {
          echo "## üìä Code Statistics"
          echo ""
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC') for release \`${{ github.ref_name }}\`"
          echo ""
          echo "This report tracks project complexity to maintain the goal of a minimal, dependency-free JVM agent."
          echo ""
          echo "\`\`\`"
          tokei --sort code .
          echo "\`\`\`"
          echo ""
          echo "**Key Metrics:**"
          
          # Extract key numbers from tokei output
          TOTAL_LINES=$(tokei --output json . | grep -o '"code":[0-9]*' | head -1 | cut -d: -f2)
          TOTAL_FILES=$(find src/ -name "*.c" -o -name "*.h" | wc -l)
          
          echo "- **Total C Lines:** ${TOTAL_LINES:-"N/A"}"
          echo "- **Total C Files:** ${TOTAL_FILES:-"N/A"}"
          echo "- **External Dependencies:** 0 (excluding system libraries)"
          echo "- **Build Tool:** Custom (nob.c)"
          echo ""
          echo "*Lower complexity = easier maintenance, faster builds, and reduced attack surface.*"
        } > tokei_report.md
        
        echo "‚úì Code statistics generated"
        
    - name: Update README with statistics
      run: |
        echo "Updating README.md..."
        
        # Remove existing tokei section if present
        if grep -q "<!-- TOKEI-START -->" README.md; then
          sed '/<!-- TOKEI-START -->/,/<!-- TOKEI-END -->/d' README.md > readme_new.md
        else
          cp README.md readme_new.md
        fi
        
        # Add new tokei section
        {
          echo ""
          echo "<!-- TOKEI-START -->"
          cat tokei_report.md
          echo "<!-- TOKEI-END -->"
        } >> readme_new.md
        
        mv readme_new.md README.md
        echo "‚úì README.md updated"
    
    - name: Verify release artifacts
      run: |
        echo "Checking build artifacts..."
        ls -la ./build/
        
        # Verify CLI executable
        test -f ./build/cli
        test -x ./build/cli
        echo "‚úì CLI executable found and is executable"
        
        # Verify agent library
        test -f ./build/libcooper.so
        file ./build/libcooper.so | grep -q "shared object"
        echo "‚úì libcooper.so found and is valid shared library"

        # Verify tui library
        test -f ./build/libtui.so
        file ./build/libtui.so | grep -q "shared object"
        echo "‚úì libtui.so found and is valid shared library"
        
        # Get artifact sizes for release notes
        CLI_SIZE=$(stat -c%s ./build/cli)
        AGENT_SIZE=$(stat -c%s ./build/libcooper.so)
        LIBTUI_SIZE=$(stat -c%s ./build/libtui.so)
        echo "CLI_SIZE=$CLI_SIZE" >> $GITHUB_ENV
        echo "AGENT_SIZE=$AGENT_SIZE" >> $GITHUB_ENV
        echo "LIBTUI_SIZE=$LIBTUI_SIZE" >> $GITHUB_ENV
        
    - name: Generate comprehensive changelog
      id: changelog
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$CURRENT_TAG$" | head -1)
        
        echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
        
        # Create changelog with categorized commits
        {
          echo "## üöÄ Changes in $CURRENT_TAG"
          echo ""
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # Features
            FEATURES=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG | grep -i "feat\|add\|new" || true)
            if [ -n "$FEATURES" ]; then
              echo "### ‚ú® New Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Fixes
            FIXES=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG | grep -i "fix\|bug\|patch" || true)
            if [ -n "$FIXES" ]; then
              echo "### üêõ Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # Other changes
            OTHER=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG | grep -vi "feat\|add\|new\|fix\|bug\|patch" || true)
            if [ -n "$OTHER" ]; then
              echo "### üîß Other Changes"
              echo "$OTHER"
              echo ""
            fi
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...$CURRENT_TAG"
          else
            echo "### üéâ Initial Release"
            git log --pretty=format:"- %s (%h)" | head -10
          fi
        } > CHANGELOG.md
        
        # Set multiline output
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ${{ github.ref_name }}
        body: |
          ${{ steps.changelog.outputs.changelog }}
          
          ## üì¶ Release Assets
          
          | File | Size | Description |
          |------|------|-------------|
          | `cli` | ${{ env.CLI_SIZE }} bytes | Cooper command-line monitoring tool |
          | `libcooper.so` | ${{ env.AGENT_SIZE }} bytes | Cooper Java agent shared library |
          | `libtui.so` | ${{ env.LIBTUI_SIZE }} bytes | TUI library |
          
          ## üèóÔ∏è Build Information
          - **Platform**: Linux x86_64
          - **Compiler**: GCC (default)
          - **Built**: ${{ github.run_id }} on ${{ github.run_attempt }}
          - **Commit**: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          <!-- TODO: Add ARM64 builds for broader compatibility -->
          <!-- TODO: Add GPG signatures for artifact verification -->
          <!-- TODO: Add SHA256 checksums for integrity validation -->
        draft: false
        prerelease: false
        
    - name: Upload cli executable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/cli
        asset_name: cli
        asset_content_type: application/octet-stream

    - name: Upload libtui ui lib for cli
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/libtui.so
        asset_name: libtui.so
        asset_content_type: application/octet-stream
        
    - name: Upload cooper shared library
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/libcooper.so
        asset_name: libcooper.so
        asset_content_type: application/octet-stream

    - name: Commit README updates to main
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Switch to main and commit
        git checkout main
        git add README.md
        
        if ! git diff --staged --quiet; then
          git commit -m "üìä Update code statistics for ${{ github.ref_name }}"\
                     -m "Auto-generated complexity metrics to track minimal dependencies goal." \
                     -m "Release: ${{ github.ref_name }}" \
                     -m "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                     
          git push origin main
          echo "‚úÖ Code statistics committed to main branch"
        else
          echo "‚ÑπÔ∏è  No statistics changes to commit"
        fi
